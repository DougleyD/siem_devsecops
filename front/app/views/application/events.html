{% extends "application/base.html" %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/events.css') }}">
{% endblock %}

{% block section %}
<div class="filter-line">
  <div class="filter-content">
    <form id="filter-form">
      <div class="icon-search">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <input type="text" id="search-input" placeholder="Search by field" />
      <select id="agent-select">
        <option value="">All agents</option>
        {% for log in logs %}
          <option value="{{ log.agent_id }}">{{ log.agent_id }}</option>
        {% endfor %}
      </select>

      <select id="sort-select">
        <option value="time_asc">Newest first</option>
        <option value="time_desc">Oldest first</option>
        <option value="agent_asc">Agent ID (A-Z)</option>
        <option value="agent_desc">Agent ID (Z-A)</option>
        <option value="severity">Severity (High first)</option>
      </select>
    </form>
  </div>
</div>

<div class="title-line">
  <div class="title-info">
    <button class="title-bttn"><i class="fa-solid fa-chart-simple"></i></button>
    <div class="field-time">Timestamp</div>
    <div class="field-event">Event ID</div>
    <div class="field-agent">Agent ID</div>
    <div class="field-host">Hostname</div>
    <div class="field-ip">IP</div>
    <div class="field-desc">Message</div>
    <div class="field-cat">Category</div>
  </div>
</div>

<div class="events-container">
  {% for log in logs %}
  <div class="event-line">
    <div class="resume-info">
      <button class="field-bttn"><i class="fa-solid fa-chevron-right"></i></button>
      <div class="field-time">{{ log.timestamp }}</div>
      <div class="field-event">{{ log.id }}</div>
      <div class="field-agent">{{ log.agent_id }}</div>
      <div class="field-host">{{ log.hostname }}</div>
      <div class="field-ip">{{ log.ip }}</div>
      <div class="field-desc">{{ log.description }}</div>
      <div class="field-cat">{{ log.category }}</div>
    </div>
  </div>
  <div class="complete-line">
    <div class="complete-info">
      <div class="complete-column">
        <div class="column-header">Full Status</div>
        <div class="scrollable-content">
          <div class="complete-field"><span class="field-label">User:</span> {{ log.full.agent.user or "N/A" }}</div>
          <div class="complete-field"><span class="field-label">Hostname:</span> {{ log.full.agent.hostname or "N/A" }}</div>
          <div class="complete-field"><span class="field-label">Service:</span> {{ log.full.event.service or "N/A" }}</div>
          <div class="complete-field"><span class="field-label">Port:</span> {{ log.full.event.port or "N/A" }}</div>
          <div class="complete-field"><span class="field-label">Directory:</span> {{ log.full.event.directory or "N/A" }}</div>
          <div class="complete-field"><span class="field-label">Authentication:</span>
            {{ log.full.event.authentication.status|capitalize }} ({{ log.full.event.authentication.attempts }} attempts)
          </div>
          <div class="complete-field"><span class="field-label">Web:</span> {{ log.full.event.web or "N/A" }}</div>
        </div>
      </div>
      <div class="complete-column json-column">
        <div class="column-header">JSON</div>
        <div class="scrollable-content">
          <pre>{{ log.full | tojson(indent=2) }}</pre>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.field-bttn').forEach(button => {
    button.addEventListener('click', function() {
      const eventLine = this.closest('.event-line');
      const completeLine = eventLine.nextElementSibling;
      if (completeLine && completeLine.classList.contains('complete-line')) {
        completeLine.style.display = completeLine.style.display === 'flex' ? 'none' : 'flex';
        const icon = this.querySelector('i');
        icon.classList.toggle('fa-chevron-right');
        icon.classList.toggle('fa-chevron-down');
      }
    });
  });
});
</script>
{% endblock %}

